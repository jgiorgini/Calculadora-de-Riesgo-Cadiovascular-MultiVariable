
<!doctype html>
<html lang="es" class="h-full">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Integrador de Riesgo CV</title>
    <meta name="description" content="Calculadora integradora de riesgo cardiovascular con ajuste por ateromatosis subclínica, factores psicosociales y antecedentes oncológicos." />
    <script>
      tailwind = window.tailwind || {};
      tailwind.config = { darkMode: 'class' };
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      :root { --radius: 16px; }
      .card { border-radius: var(--radius); }
      @media (max-width: 480px) {
        html { font-size: 17px; }
        .btn { padding: 0.75rem 1rem; border-radius: 9999px; }
        .stack > * { width: 100%; }
      }
      @media print {
        body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
        .no-print { display: none !important; }
        .print-area, .print-area * { visibility: visible !important; }
        body *:not(.print-area):not(.print-area *) { visibility: hidden !important; }
        .print-area { position: absolute; inset: 0; padding: 24px; background: white; }
      }
    </style>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  </head>
  <body class="bg-slate-50 h-full">
    <div id="root"></div>

    <script type="text/babel">
      const { useMemo, useState, useEffect } = React;

      const clamp = (x, min, max) => Math.min(Math.max(x, min), max);
      const toNumber = (v, fallback = 0) => { const n = typeof v === "number" ? v : parseFloat(String(v)); return Number.isFinite(n) ? n : fallback; };
      const pretty = (x) => `${toNumber(x, 0).toFixed(1)}%`;
      const normalizeCAC = (v) => { const s = String(v).trim(); if (s === "0") return "0"; if (s === "1_99" || s === "1-99") return "1_99"; if (s === "100_299" || s === "100-299") return "100_299"; if (s === "300_plus" || s === "300+" || s === ">=300" || s === "≥300") return "300_plus"; return "unknown"; };
      const categorizeLabel = (r) => (r < 5 ? "Bajo" : r < 10 ? "Límite" : r < 20 ? "Intermedio" : "Alto");

      const defaultState = {
        baseRisk: 0,
        baseSource: "SCORE2 (ESC 2021)",
        cac: "unknown",
        territories: 0, // 0..4
        psychosocial: { depression: "none", anxiety: "none" },
        oncology: "none",
        multipliers: {
          cac_unknown: 1.0, cac_0: 0.70, cac_1_99: 1.5, cac_100_299: 2.2, cac_300_plus: 3.0,
          terr_0: 1.00, terr_1: 1.25, terr_2: 1.45, terr_3: 1.65, terr_4: 1.85,
          carotid_none: 1.0, carotid_present: 1.4,
          dep_none: 1.0, dep_mild: 1.15, dep_major: 1.30,
          anx_none: 1.0, anx_clinical: 1.20,
          onco_none: 1.0, onco_noncardio: 1.15, onco_cardio: 1.40,
        },
      };

      function App() {
        const [s, setS] = useState(() => {
          try {
            const raw = window.localStorage?.getItem("cv_risk_integrator_state_v2");
            const parsed = raw ? JSON.parse(raw) : {};
            const safe = { ...defaultState, ...parsed };
            safe.baseRisk = 0;
            const mm = { ...defaultState.multipliers, ...(safe.multipliers || {}) };
            for (const k of Object.keys(mm)) mm[k] = toNumber(mm[k], defaultState.multipliers[k]);
            safe.multipliers = mm;
            safe.cac = normalizeCAC(safe.cac);
            safe.territories = clamp(parseInt(safe.territories || 0, 10) || 0, 0, 4);
            return safe;
          } catch { return defaultState; }
        });

        const [dark, setDark] = useState(() => {
          try {
            const saved = window.localStorage.getItem("cv_risk_ui_dark");
            if (saved === "true" || saved === "false") return JSON.parse(saved);
          } catch {}
          return false;
        });
        useEffect(() => {
          try { window.localStorage.setItem("cv_risk_ui_dark", JSON.stringify(dark)); } catch {}
          document.documentElement.classList.toggle("dark", !!dark);
        }, [dark]);

        const [baseRiskInput, setBaseRiskInput] = useState("");
        useEffect(() => { setBaseRiskInput(String(s.baseRisk)); }, []);
        const [showAdvanced, setShowAdvanced] = useState(false);
        const [testResults, setTestResults] = useState(null);
        const [extResults, setExtResults] = useState(null);

        useEffect(() => {
          try {
            const { baseRisk, ...rest } = s;
            window.localStorage?.setItem("cv_risk_integrator_state_v2", JSON.stringify(rest));
          } catch {}
        }, [s]);

        const onBaseRiskChange = (val) => {
          setBaseRiskInput(val);
          const normalized = String(val).replace(",", ".").trim();
          const num = parseFloat(normalized);
          if (Number.isFinite(num)) {
            const clamped = clamp(num, 0, 60);
            if (clamped !== s.baseRisk) setS({ ...s, baseRisk: clamped });
          }
        };

        const cacMult = useMemo(() => {
          const m = s.multipliers;
          switch (normalizeCAC(s.cac)) {
            case "0": return m.cac_0;
            case "1_99": return m.cac_1_99;
            case "100_299": return m.cac_100_299;
            case "300_plus": return m.cac_300_plus;
            default: return m.cac_unknown;
          }
        }, [s]);
        const terrMult = useMemo(() => {
          const m = s.multipliers;
          const t = clamp(parseInt(s.territories || 0, 10) || 0, 0, 4);
          const key = `terr_${t}`;
          return toNumber(m[key], 1.0);
        }, [s]);
        const psychosocialMultiplier = useMemo(() => {
          const m = s.multipliers;
          const dep = s.psychosocial.depression === "mild" ? m.dep_mild : s.psychosocial.depression === "major" ? m.dep_major : m.dep_none;
          const anx = s.psychosocial.anxiety === "clinical" ? m.anx_clinical : m.anx_none;
          return clamp(toNumber(dep, 1) * toNumber(anx, 1), 1.0, 1.6);
        }, [s]);
        const oncologyMultiplier = useMemo(() => {
          const m = s.multipliers;
          if (s.oncology === "cancer_noncardiotox") return m.onco_noncardio;
          if (s.oncology === "anthracycline_or_rt") return m.onco_cardio;
          return m.onco_none;
        }, [s]);

        const atheroMultiplier = useMemo(() => toNumber(cacMult, 1) * toNumber(terrMult, 1), [cacMult, terrMult]);
        const compositeMultiplier = useMemo(() => toNumber(atheroMultiplier, 1) * toNumber(psychosocialMultiplier, 1) * toNumber(oncologyMultiplier, 1), [atheroMultiplier, psychosocialMultiplier, oncologyMultiplier]);

        const adjustedRisk = useMemo(() => {
          const base = clamp(Number(s.baseRisk) || 0, 0, 60);
          const adj = clamp(base * (Number(compositeMultiplier) || 1), 0, 95);
          return { base, adj };
        }, [s, compositeMultiplier]);

        const category = useMemo(() => {
          const r = adjustedRisk.adj;
          if (r < 5) return { label: "Bajo", color: "bg-emerald-100 text-emerald-900" };
          if (r < 10) return { label: "Límite", color: "bg-yellow-100 text-yellow-900" };
          if (r < 20) return { label: "Intermedio", color: "bg-orange-100 text-orange-900" };
          return { label: "Alto", color: "bg-red-100 text-red-900" };
        }, [adjustedRisk]);

        // calcWith determinístico desde defaults
        function calcWith(overrides = {}, opts = {}) {
          const cap = Number.isFinite(opts.cap) ? opts.cap : 95;
          const baseSt = JSON.parse(JSON.stringify(defaultState));
          const st = { ...baseSt, ...overrides, psychosocial: { ...baseSt.psychosocial, ...(overrides.psychosocial || {}) } };
          const m = { ...defaultState.multipliers, ...(overrides.multipliers || {}) };

          let cac = 1.0;
          switch (normalizeCAC(st.cac)) {
            case "0": cac = m.cac_0; break;
            case "1_99": cac = m.cac_1_99; break;
            case "100_299": cac = m.cac_100_299; break;
            case "300_plus": cac = m.cac_300_plus; break;
            default: cac = m.cac_unknown; break;
          }
          const t = clamp(parseInt(st.territories || 0, 10) || 0, 0, 4);
          const terr = toNumber(m[`terr_${t}`], 1.0);
          const athero = toNumber(cac, 1.0) * toNumber(terr, 1.0);
          const dep = st.psychosocial.depression === "mild" ? m.dep_mild : st.psychosocial.depression === "major" ? m.dep_major : m.dep_none;
          const anx = st.psychosocial.anxiety === "clinical" ? m.anx_clinical : m.anx_none;
          const psych = clamp(toNumber(dep, 1.0) * toNumber(anx, 1.0), 1.0, 1.6);
          const onco = st.oncology === "cancer_noncardiotox" ? m.onco_noncardio : st.oncology === "anthracycline_or_rt" ? m.onco_cardio : m.onco_none;
          const comp = toNumber(athero, 1.0) * toNumber(psych, 1.0) * toNumber(onco, 1.0);
          const base = clamp(Number(st.baseRisk) || 0, 0, 60);
          const adjRaw = base * comp;
          const adj = clamp(adjRaw, 0, cap);
          return { base, comp, adj, adjRaw, athero, cac, terr, psych, onco };
        }

        function runExtendedTests() {
          const results = [];
          const base = 10;
          // neutral
          const neutral = { territories:0, psychosocial:{depression:"none",anxiety:"none"}, oncology:"none" };
          // unknown forzado a 1.0 para garantizar el invariante del test
          const rUnknown = calcWith({ ...neutral, baseRisk: base, cac: "unknown", multipliers: { cac_unknown: 1.0 } }).adj;
          const r0 = calcWith({ ...neutral, baseRisk: base, cac: "0" }).adj;
          const r1 = calcWith({ ...neutral, baseRisk: base, cac: "1_99" }).adj;
          const r100 = calcWith({ ...neutral, baseRisk: base, cac: "100_299" }).adj;
          const r300 = calcWith({ ...neutral, baseRisk: base, cac: "300_plus" }).adj;
          const okCAC = Math.abs(rUnknown - base) < 1e-9 && r0 < r1 && r1 < r100 && r100 < r300;
          results.push({ name: `Orden CAC (base=${base}%)`, got: `${r0.toFixed(1)} < ${r1.toFixed(1)} < ${r100.toFixed(1)} < ${r300.toFixed(1)} (unknown=${rUnknown.toFixed(1)})`, expected: "0 < 1_99 < 100_299 < 300_plus; unknown=base", pass: okCAC });

          // otras pruebas
          const catCases = [{r:4.9,expect:"Bajo"},{r:5.0,expect:"Límite"},{r:9.9,expect:"Límite"},{r:10.0,expect:"Intermedio"},{r:19.9,expect:"Intermedio"},{r:20.0,expect:"Alto"}];
          for (const c of catCases) { const got = categorizeLabel(c.r); results.push({ name: `Categoría @ ${c.r}%`, got, expected: c.expect, pass: got === c.expect }); }

          const bases = [0,1,5,10,30,60]; const vals = bases.map((b)=>calcWith({baseRisk:b, territories:0, cac:"unknown", multipliers:{ cac_unknown:1.0 }, psychosocial:{depression:"none",anxiety:"none"}, oncology:"none"}).adj);
          let mono = true; for (let i=1;i<vals.length;i++) if (vals[i] < vals[i-1] - 1e-9) mono=false;
          results.push({ name: "Monotonicidad baseRisk", got: mono ? "no decrece" : "decreció", expected: "no decrece", pass: mono });

          setExtResults(results);
        }

        function runTests() {
          const baseCases = [
            { name: "Sin modificadores", cfg: { baseRisk: 10, psychosocial: { depression: "none", anxiety: "none" }, oncology: "none", cac:"unknown", territories:0, multipliers:{ cac_unknown:1.0 } }, expectAdj: 10.0 },
            { name: "CAC=0 reduce", cfg: { baseRisk: 10, cac: "0", territories: 0 }, expectAdj: 7.0 },
            { name: "CAC 100–299 eleva", cfg: { baseRisk: 10, cac: "100_299", territories: 0 }, expectAdj: 22.0 },
            { name: "Psicosocial mayor + ansiedad clínica", cfg: { baseRisk: 10, psychosocial: { depression: "major", anxiety: "clinical" } }, expectAdj: 15.6 },
            { name: "Onco cardiotóxicos", cfg: { baseRisk: 10, oncology: "anthracycline_or_rt" }, expectAdj: 14.0 },
            { name: "Territorios = 2", cfg: { baseRisk: 10, territories: 2 }, expectAdj: 14.5 },
            { name: "Combinado fuerte (defaults) CAC300+, Terr=3, dep mayor, onco", cfg: { baseRisk: 8, cac: "300_plus", territories: 3, psychosocial: { depression: "major", anxiety: "none" }, oncology: "anthracycline_or_rt" }, expectAdj: 72.8 },
          ];
          const results = baseCases.map((t) => {
            const r = calcWith(t.cfg, { cap: 95 });
            const pass = Math.abs(r.adj - t.expectAdj) < 0.11;
            return { name: t.name, got: r.adj, expected: t.expectAdj, pass };
          });
          setTestResults(results);
        }

        return (
          <div className="min-h-screen w-full bg-slate-50 dark:bg-slate-900 dark:text-slate-100 text-slate-900 p-4 md:p-6">
            <div className="max-w-4xl mx-auto space-y-6">
              <header className="flex items-center justify-between">
                <h1 className="text-2xl md:text-3xl font-semibold tracking-tight">Integrador de Riesgo CV</h1>
                <div className="flex flex-wrap gap-2 items-center no-print stack">
                  <button onClick={() => setDark((v) => !v)} className="btn px-3 py-2 rounded-2xl shadow bg-white dark:bg-slate-800 hover:bg-slate-100 border">{dark ? "Claro" : "Oscuro"}</button>
                  <button onClick={() => window.print()} className="btn px-3 py-2 rounded-2xl shadow bg-white dark:bg-slate-800 hover:bg-slate-100 border">PDF (imprimir)</button>
                  <button onClick={() => { const def = { ...defaultState }; const { baseRisk, ...rest } = def; localStorage.setItem("cv_risk_integrator_state_v2", JSON.stringify(rest)); location.reload(); }} className="btn px-3 py-2 rounded-2xl shadow bg-white dark:bg-slate-800 hover:bg-slate-100 border">Reiniciar (app)</button>
                  <button onClick={() => { try { localStorage.clear(); } catch(e){} location.reload(); }} className="btn px-3 py-2 rounded-2xl shadow bg-white dark:bg-slate-800 hover:bg-slate-100 border">Reset (limpiar todo)</button>
                </div>
              </header>

              <div className="grid md:grid-cols-2 gap-6">
                <section className="card bg-white dark:bg-slate-800 shadow p-4 space-y-4 border">
                  <h2 className="text-lg font-semibold">1) Riesgo base</h2>
                  <label className="block text-sm">Riesgo a 10 años (%)</label>
                  <input type="text" inputMode="decimal" placeholder="Ej.: 7.5" className="w-full border rounded-xl px-3 py-2 dark:bg-slate-900" value={baseRiskInput} onChange={(e) => onBaseRiskChange(e.target.value)} />
                  <div className="text-xs text-slate-500 dark:text-slate-400">Tipeá con coma o punto. Se aplica en tiempo real (0–60%).</div>
                </section>

                <section className="card bg-white dark:bg-slate-800 shadow p-4 space-y-4 border">
                  <h2 className="text-lg font-semibold">2) Ateromatosis subclínica</h2>
                  <div className="grid gap-3">
                    <div>
                      <label className="block text-sm">CAC (categoría)</label>
                      <select className="w-full border rounded-xl px-3 py-2 dark:bg-slate-900" value={s.cac} onChange={(e) => setS({ ...s, cac: normalizeCAC(e.target.value) })}>
                        <option value="unknown">Desconocido</option>
                        <option value="0">0</option>
                        <option value="1_99">1–99</option>
                        <option value="100_299">100–299</option>
                        <option value="300_plus">≥300</option>
                      </select>
                    </div>
                    <div>
                      <label className="block text-sm">Territorios con placa (carótida, aorta abd., ilíacas, femorales)</label>
                      <select className="w-full border rounded-xl px-3 py-2 dark:bg-slate-900" value={s.territories} onChange={(e) => setS({ ...s, territories: clamp(parseInt(e.target.value,10)||0,0,4) })}>
                        <option value="0">0</option>
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                      </select>
                    </div>
                  </div>
                </section>
              </div>

              <section className="card bg-white dark:bg-slate-800 shadow p-5 border print-area mt-6">
                <h2 className="text-lg font-semibold mb-3">Resultado</h2>
                <div className="grid md:grid-cols-3 gap-4 items-stretch">
                  <div className="border rounded-2xl p-4 bg-slate-50 dark:bg-slate-900">
                    <div className="text-xs uppercase tracking-wide text-slate-500 dark:text-slate-400">Riesgo base</div>
                    <div className="text-3xl font-semibold">{pretty(adjustedRisk.base)}</div>
                    <div className="text-xs text-slate-500 dark:text-slate-400">CAC: {s.cac.replace("_","-")} | Terr: {s.territories}</div>
                  </div>
                  <div className="border rounded-2xl p-4 bg-slate-50 dark:bg-slate-900">
                    <div className="text-xs uppercase tracking-wide text-slate-500 dark:text-slate-400">Multiplicador compuesto</div>
                    <div className="text-3xl font-semibold">× {toNumber(compositeMultiplier, 1).toFixed(2)}</div>
                  </div>
                  <div className="border rounded-2xl p-4 bg-emerald-100 text-emerald-900">
                    <div className="text-xs uppercase tracking-wide">Riesgo ajustado</div>
                    <div className="text-3xl font-semibold">{pretty(adjustedRisk.adj)}</div>
                  </div>
                </div>
              </section>

              <section className="card bg-white dark:bg-slate-800 shadow p-5 border mt-6">
                <div className="flex items-center justify-between no-print">
                  <h2 className="text-lg font-semibold mb-2">Pruebas automáticas</h2>
                  <div className="flex gap-2">
                    <button onClick={runTests} className="px-3 py-2 rounded-2xl shadow bg-white dark:bg-slate-900 hover:bg-slate-100 border">Ejecutar tests</button>
                    <button onClick={runExtendedTests} className="px-3 py-2 rounded-2xl shadow bg-white dark:bg-slate-900 hover:bg-slate-100 border">Validación extendida</button>
                  </div>
                </div>
                {Array.isArray(testResults) && (
                  <ul className="mt-3 grid md:grid-cols-2 gap-2 text-sm">
                    {testResults.map((t, i) => (
                      <li key={i} className={`border rounded-xl px-3 py-2 ${t.pass ? "bg-emerald-50 dark:bg-emerald-900/20" : "bg-red-50 dark:bg-red-900/20"}`}>
                        <div className="font-medium">{t.name}</div>
                        <div>Resultado: {typeof t.got === 'number' ? t.got.toFixed(2) + "%" : String(t.got)}</div>
                        <div>Esperado: {typeof t.expected === 'number' ? t.expected.toFixed(2) + "%" : String(t.expected)}</div>
                        <div className="text-xs">{t.pass ? "OK" : "FALLÓ"}</div>
                      </li>
                    ))}
                  </ul>
                )}
                {Array.isArray(extResults) && (
                  <ul className="mt-3 grid md:grid-cols-2 gap-2 text-sm">
                    {extResults.map((t, i) => (
                      <li key={i} className={`border rounded-xl px-3 py-2 ${t.pass ? "bg-emerald-50 dark:bg-emerald-900/20" : "bg-red-50 dark:bg-red-900/20"}`}>
                        <div className="font-medium">{t.name}</div>
                        <div>Resultado: {typeof t.got === 'number' ? t.got.toFixed(2) : String(t.got)}</div>
                        <div className="text-xs">Esperado: {typeof t.expected === 'number' ? t.expected : String(t.expected)} — {t.pass ? "OK" : "FALLÓ"}</div>
                      </li>
                    ))}
                  </ul>
                )}
              </section>

              <footer className="text-xs text-slate-500 dark:text-slate-400 pt-2 pb-24 md:pb-2">
                © {new Date().getFullYear()} – Uso educativo. No reemplaza guías clínicas ni juicio profesional.
              </footer>
            </div>
          </div>
        );
      }

      ReactDOM.createRoot(document.getElementById("root")).render(<App />);
    </script>
  </body>
</html>
