
<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Integrador de Riesgo CV</title>
    <meta name="description" content="Calculadora integradora de riesgo cardiovascular con ajuste por ateromatosis subclínica, factores psicosociales y antecedentes oncológicos." />
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  </head>
  <body class="bg-slate-50">
    <div id="root"></div>

    <script type="text/babel">
      const STORAGE_KEY = "cv_risk_integrator_state_v2";
      const { useMemo, useState, useEffect } = React;

      const clamp = (x, min, max) => Math.min(Math.max(x, min), max);
      const toNumber = (v, fallback = 0) => {
        const n = typeof v === "number" ? v : parseFloat(String(v));
        return Number.isFinite(n) ? n : fallback;
      };
      const pretty = (x) => `${toNumber(x, 0).toFixed(1)}%`;

      const normalizeCAC = (v) => {
        const s = String(v).trim();
        if (s === "0") return "0";
        if (s === "1_99" || s === "1-99") return "1_99";
        if (s === "100_299" || s === "100-299") return "100_299";
        if (s === "300_plus" || s === "300+" || s === ">=300" || s === "≥300") return "300_plus";
        return "unknown";
      };

      const defaultState = {
        baseRisk: 0,
        baseSource: "SCORE2 / PCE / MESA",
        atheroMode: "none",
        cac: "unknown",
        carotidPlaque: "unknown",
        psychosocial: { depression: "none", anxiety: "none" },
        oncology: "none", // none | cancer_noncardiotox | anthracycline_or_rt
        multipliers: {
          cac_unknown: 1.0, cac_0: 0.70, cac_1_99: 1.5, cac_100_299: 2.2, cac_300_plus: 3.0,
          carotid_none: 1.0, carotid_present: 1.4,
          dep_none: 1.0, dep_mild: 1.15, dep_major: 1.30,
          anx_none: 1.0, anx_clinical: 1.20,
          onco_none: 1.0, onco_noncardio: 1.15, onco_cardio: 1.40,
        },
      };

      function App() {
        const [s, setS] = useState(() => {
          try {
            const raw = window.localStorage?.getItem(STORAGE_KEY);
            const parsed = raw ? JSON.parse(raw) : {};
            const safe = { ...defaultState, ...parsed };
            // preservar 0 como válido
            safe.baseRisk = toNumber(safe.baseRisk, defaultState.baseRisk);
            const mm = { ...defaultState.multipliers, ...(safe.multipliers || {}) };
            for (const k of Object.keys(mm)) mm[k] = toNumber(mm[k], defaultState.multipliers[k]);
            safe.multipliers = mm;
            safe.cac = normalizeCAC(safe.cac);
            return safe;
          } catch { return defaultState; }
        });

        const [baseRiskInput, setBaseRiskInput] = useState("");
        useEffect(() => { setBaseRiskInput(String(s.baseRisk)); }, []);
        const [showAdvanced, setShowAdvanced] = useState(false);
        const [testResults, setTestResults] = useState(null);

        useEffect(() => {
          try { window.localStorage?.setItem(STORAGE_KEY, JSON.stringify(s)); } catch {}
        }, [s]);

        const atheroMultiplier = useMemo(() => {
          const m = s.multipliers;
          if (s.atheroMode === "cac") {
            const key = normalizeCAC(s.cac);
            switch (key) {
              case "0": return m.cac_0;
              case "1_99": return m.cac_1_99;
              case "100_299": return m.cac_100_299;
              case "300_plus": return m.cac_300_plus;
              default: return m.cac_unknown;
            }
          }
          if (s.atheroMode === "carotid") return s.carotidPlaque === "present" ? m.carotid_present : m.carotid_none;
          return 1.0;
        }, [s]);

        const psychosocialMultiplier = useMemo(() => {
          const m = s.multipliers;
          const dep = s.psychosocial.depression === "mild" ? m.dep_mild : s.psychosocial.depression === "major" ? m.dep_major : m.dep_none;
          const anx = s.psychosocial.anxiety === "clinical" ? m.anx_clinical : m.anx_none;
          return clamp(toNumber(dep, 1) * toNumber(anx, 1), 1.0, 1.6);
        }, [s]);

        const oncologyMultiplier = useMemo(() => {
          const m = s.multipliers;
          if (s.oncology === "cancer_noncardiotox") return m.onco_noncardio;
          if (s.oncology === "anthracycline_or_rt") return m.onco_cardio;
          return m.onco_none;
        }, [s]);

        const compositeMultiplier = useMemo(
          () => toNumber(atheroMultiplier, 1) * toNumber(psychosocialMultiplier, 1) * toNumber(oncologyMultiplier, 1),
          [atheroMultiplier, psychosocialMultiplier, oncologyMultiplier]
        );

        const adjustedRisk = useMemo(() => {
          const base = clamp(Number(s.baseRisk) || 0, 0, 60);
          const adj = clamp(base * (Number(compositeMultiplier) || 1), 0, 95);
          return { base, adj };
        }, [s, compositeMultiplier]);

        const category = useMemo(() => {
          const r = adjustedRisk.adj;
          if (r < 5) return { label: "Bajo", color: "bg-emerald-100 text-emerald-900" };
          if (r < 10) return { label: "Límite", color: "bg-yellow-100 text-yellow-900" };
          if (r < 20) return { label: "Intermedio", color: "bg-orange-100 text-orange-900" };
          return { label: "Alto", color: "bg-red-100 text-red-900" };
        }, [adjustedRisk]);

        const commitBaseRisk = () => {
          const normalized = String(baseRiskInput).replace(",", ".").trim();
          const val = parseFloat(normalized);
          const num = Number.isFinite(val) ? clamp(val, 0, 60) : s.baseRisk;
          setS({ ...s, baseRisk: num });
          setBaseRiskInput(String(num));
        };

        const reset = () => {
          setS(defaultState);
          setBaseRiskInput(String(defaultState.baseRisk));
        };

        function runTests() {
          const baseCases = [
            { name: "Sin modificadores", cfg: { baseRisk: 10, atheroMode: "none", psychosocial: { depression: "none", anxiety: "none" }, oncology: "none" }, expectAdj: 10.0 },
            { name: "CAC=0 reduce riesgo", cfg: { baseRisk: 10, atheroMode: "cac", cac: "0" }, expectAdj: 7.0 },
            { name: "CAC 100–299 eleva riesgo", cfg: { baseRisk: 10, atheroMode: "cac", cac: "100_299" }, expectAdj: 22.0 },
            { name: "Psicosocial mayor + ansiedad clínica", cfg: { baseRisk: 10, psychosocial: { depression: "major", anxiety: "clinical" } }, expectAdj: 15.6 },
            { name: "Onco cardiotóxicos", cfg: { baseRisk: 10, oncology: "anthracycline_or_rt" }, expectAdj: 14.0 },
            { name: "Combinado fuerte", cfg: { baseRisk: 8, atheroMode: "cac", cac: "300_plus", psychosocial: { depression: "major", anxiety: "none" }, oncology: "anthracycline_or_rt" }, expectAdj: 43.7 },
          ];
          const extraCases = [
            { name: "Carótida con placa presente", cfg: { baseRisk: 10, atheroMode: "carotid", carotidPlaque: "present" }, expectAdj: 14.0 },
            { name: "Onco no cardiotóxicos", cfg: { baseRisk: 10, oncology: "cancer_noncardiotox" }, expectAdj: 11.5 },
            { name: "CAC desconocido (sin efecto)", cfg: { baseRisk: 10, atheroMode: "cac", cac: "unknown" }, expectAdj: 10.0 },
            { name: "baseRisk como string", cfg: { baseRisk: "10", atheroMode: "cac", cac: "0" }, expectAdj: 7.0 },
            { name: "CAC 1-99 (guion)", cfg: { baseRisk: 10, atheroMode: "cac", cac: "1-99" }, expectAdj: 15.0 },
            { name: "CAC 300+ (plus)", cfg: { baseRisk: 10, atheroMode: "cac", cac: "300+" }, expectAdj: 30.0 },
            { name: "Carótida unknown (sin efecto)", cfg: { baseRisk: 10, atheroMode: "carotid", carotidPlaque: "unknown" }, expectAdj: 10.0 },
            { name: "baseRisk vacío => 0", cfg: { baseRisk: "", atheroMode: "cac", cac: "300_plus" }, expectAdj: 0.0 },
            { name: "Clamp psicosocial a 1.6", cfg: { baseRisk: 10, psychosocial: { depression: "major", anxiety: "clinical" }, multipliers: { dep_major: 2.0, anx_clinical: 2.0 } }, expectAdj: 16.0 },
          ];
          const all = [...baseCases, ...extraCases];
          function calcWith(overrides) {
            const st = { ...s, ...overrides };
            const m = st.multipliers;
            let athero = 1.0;
            if (st.atheroMode === "cac") {
              const key = normalizeCAC(st.cac);
              const map = { unknown: m.cac_unknown, "0": m.cac_0, "1_99": m.cac_1_99, "100_299": m.cac_100_299, "300_plus": m.cac_300_plus };
              athero = toNumber(map[key], 1.0);
            } else if (st.atheroMode === "carotid") {
              athero = st.carotidPlaque === "present" ? toNumber(m.carotid_present, 1.4) : toNumber(m.carotid_none, 1.0);
            }
            const dep = st.psychosocial.depression === "mild" ? m.dep_mild : st.psychosocial.depression === "major" ? m.dep_major : m.dep_none;
            const anx = st.psychosocial.anxiety === "clinical" ? m.anx_clinical : m.anx_none;
            const psych = clamp(toNumber(dep, 1.0) * toNumber(anx, 1.0), 1.0, 1.6);
            const onco = st.oncology === "cancer_noncardiotox" ? m.onco_noncardio : st.oncology === "anthracycline_or_rt" ? m.onco_cardio : m.onco_none;
            const comp = toNumber(athero, 1.0) * toNumber(psych, 1.0) * toNumber(onco, 1.0);
            const base = clamp(Number(st.baseRisk) || 0, 0, 60);
            const adj = clamp(base * comp, 0, 95);
            return { base, comp, adj };
          }
          const results = all.map((t) => {
            const merged = { ...defaultState, ...t.cfg };
            merged.multipliers = { ...defaultState.multipliers, ...(t.cfg.multipliers || {}) };
            const r = calcWith(merged);
            const pass = Math.abs(r.adj - t.expectAdj) < 0.11;
            return { name: t.name, got: r.adj, expected: t.expectAdj, pass };
          });
          setTestResults(results);
        }

        return (
          <div className="min-h-screen w-full bg-slate-50 text-slate-900 p-6">
            <div className="max-w-4xl mx-auto space-y-6">
              <header className="flex items-center justify-between">
                <h1 className="text-2xl md:text-3xl font-semibold tracking-tight">Integrador de Riesgo CV</h1>
                <div className="flex gap-2">
                  <button onClick={() => setShowAdvanced((v) => !v)} className="px-3 py-2 rounded-2xl shadow bg-white hover:bg-slate-100 border">{showAdvanced ? "Ocultar" : "Avanzado"}</button>
                  <button onClick={() => { setS(defaultState); setBaseRiskInput(String(defaultState.baseRisk)); }} className="px-3 py-2 rounded-2xl shadow bg-white hover:bg-slate-100 border">Reiniciar</button>
                </div>
              </header>

              <div className="grid md:grid-cols-2 gap-6">
                <section className="bg-white rounded-2xl shadow p-4 space-y-4 border">
                  <h2 className="text-lg font-semibold">1) Riesgo base</h2>
                  <label className="block text-sm">Fuente del riesgo (opcional)</label>
                  <input className="w-full border rounded-xl px-3 py-2" value={s.baseSource} onChange={(e) => setS({ ...s, baseSource: e.target.value })} />
                  <label className="block text-sm">Riesgo a 10 años (%)</label>
                  <input
                    type="text" inputMode="decimal" placeholder="Ej.: 7.5"
                    className="w-full border rounded-xl px-3 py-2"
                    value={baseRiskInput}
                    onChange={(e) => setBaseRiskInput(e.target.value)}
                    onBlur={commitBaseRisk}
                    onKeyDown={(e) => { if (e.key === "Enter") e.currentTarget.blur(); }}
                  />
                  <div className="text-xs text-slate-500">Podés tipear con coma o punto. Enter o salir del campo para aplicar (0–60%).</div>
                </section>

                <section className="bg-white rounded-2xl shadow p-4 space-y-4 border">
                  <h2 className="text-lg font-semibold">2) Ateromatosis subclínica</h2>
                  <div className="flex gap-3">
                    <button onClick={() => setS({ ...s, atheroMode: "none" })} className={`px-3 py-1 rounded-xl border ${s.atheroMode === "none" ? "bg-slate-900 text-white" : "bg-white"}`}>Sin dato</button>
                    <button onClick={() => setS({ ...s, atheroMode: "cac" })} className={`px-3 py-1 rounded-xl border ${s.atheroMode === "cac" ? "bg-slate-900 text-white" : "bg-white"}`}>CAC</button>
                    <button onClick={() => setS({ ...s, atheroMode: "carotid" })} className={`px-3 py-1 rounded-xl border ${s.atheroMode === "carotid" ? "bg-slate-900 text-white" : "bg-white"}`}>Ecografía carotídea</button>
                  </div>
                  {s.atheroMode === "cac" && (
                    <div className="space-y-2">
                      <label className="block text-sm">Categoría de CAC</label>
                      <select className="w-full border rounded-xl px-3 py-2" value={s.cac} onChange={(e) => setS({ ...s, cac: normalizeCAC(e.target.value) })}>
                        <option value="unknown">Desconocido</option>
                        <option value="0">0</option>
                        <option value="1_99">1–99</option>
                        <option value="100_299">100–299</option>
                        <option value="300_plus">≥300</option>
                      </select>
                    </div>
                  )}
                  {s.atheroMode === "carotid" && (
                    <div className="space-y-2">
                      <label className="block text-sm">Placa carotídea</label>
                      <select className="w-full border rounded-xl px-3 py-2" value={s.carotidPlaque} onChange={(e) => setS({ ...s, carotidPlaque: e.target.value })}>
                        <option value="unknown">Desconocido</option>
                        <option value="none">Ausente</option>
                        <option value="present">Presente</option>
                      </select>
                    </div>
                  )}
                  <div className="text-sm text-slate-600">Multiplicador actual: <span className="font-semibold">× {toNumber(atheroMultiplier, 1).toFixed(2)}</span></div>
                </section>

                <section className="bg-white rounded-2xl shadow p-4 space-y-4 border">
                  <h2 className="text-lg font-semibold">3) Psicosocial</h2>
                  <div className="grid grid-cols-2 gap-4">
                    <div>
                      <label className="block text-sm">Depresión</label>
                      <select className="w-full border rounded-xl px-3 py-2" value={s.psychosocial.depression} onChange={(e) => setS({ ...s, psychosocial: { ...s.psychosocial, depression: e.target.value } })}>
                        <option value="none">Ninguna</option>
                        <option value="mild">Leve/estable</option>
                        <option value="major">Mayor/activa</option>
                      </select>
                    </div>
                    <div>
                      <label className="block text-sm">Ansiedad</label>
                      <select className="w-full border rounded-xl px-3 py-2" value={s.psychosocial.anxiety} onChange={(e) => setS({ ...s, psychosocial: { ...s.psychosocial, anxiety: e.target.value } })}>
                        <option value="none">Ninguna</option>
                        <option value="clinical">Clínica</option>
                      </select>
                    </div>
                  </div>
                  <div className="text-sm text-slate-600">Multiplicador psicosocial: <span className="font-semibold">× {toNumber(psychosocialMultiplier, 1).toFixed(2)}</span> <span className="text-xs">(limitado a ×1.6 por superposición)</span></div>
                </section>

                <!-- NUEVO: Oncología -->
                <section className="bg-white rounded-2xl shadow p-4 space-y-4 border">
                  <h2 className="text-lg font-semibold">4) Antecedentes oncológicos</h2>
                  <select className="w-full border rounded-xl px-3 py-2" value={s.oncology} onChange={(e) => setS({ ...s, oncology: e.target.value })}>
                    <option value="none">Ninguno</option>
                    <option value="cancer_noncardiotox">Cáncer previo (sin cardiotóxicos)</option>
                    <option value="anthracycline_or_rt">Antraciclinas o RT mediastinal</option>
                  </select>
                  <div className="text-sm text-slate-600">Multiplicador onco: <span className="font-semibold">× {toNumber(oncologyMultiplier, 1).toFixed(2)}</span></div>
                </section>
              </div>

              <section className="bg-white rounded-2xl shadow p-5 border">
                <h2 className="text-lg font-semibold mb-3">Resultado</h2>
                <div className="grid md:grid-cols-3 gap-4 items-stretch">
                  <div className="border rounded-2xl p-4 bg-slate-50">
                    <div className="text-xs uppercase tracking-wide text-slate-500">Riesgo base</div>
                    <div className="text-3xl font-semibold">{pretty(adjustedRisk.base)}</div>
                    <div className="text-xs text-slate-500">Fuente: {s.baseSource || "(—)"}</div>
                  </div>
                  <div className="border rounded-2xl p-4 bg-slate-50">
                    <div className="text-xs uppercase tracking-wide text-slate-500">Multiplicador compuesto</div>
                    <div className="text-3xl font-semibold">× {toNumber(compositeMultiplier, 1).toFixed(2)}</div>
                    <div className="text-xs text-slate-500">Atero × Psicosocial × Onco</div>
                  </div>
                  <div className={`border rounded-2xl p-4 ${category.color}`}>
                    <div className="text-xs uppercase tracking-wide">Riesgo ajustado</div>
                    <div className="text-3xl font-semibold">{pretty(adjustedRisk.adj)}</div>
                    <div className="text-xs">Categoría: {category.label}</div>
                  </div>
                </div>
              </section>

              {showAdvanced && (
                <section className="bg-white rounded-2xl shadow p-5 space-y-4 border">
                  <h2 className="text-lg font-semibold">Ajustes avanzados (editar multiplicadores)</h2>
                  <p className="text-sm text-slate-600">Podés personalizar los RR según tu lectura de la evidencia. Los cambios persisten localmente.</p>
                  <div className="grid md:grid-cols-3 gap-4 text-sm">
                    {Object.entries(s.multipliers).map(([key, val]) => (
                      <div key={key} className="flex items-center justify-between gap-2 border rounded-xl px-3 py-2">
                        <span className="font-mono text-xs">{key}</span>
                        <input
                          type="number" step="0.01"
                          className="w-24 border rounded-lg px-2 py-1"
                          value={toNumber(val, toNumber(defaultState.multipliers[key], 1))}
                          onChange={(e) => {
                            const num = toNumber(e.target.value, toNumber(defaultState.multipliers[key], 1));
                            setS({ ...s, multipliers: { ...s.multipliers, [key]: num } });
                          }}
                        />
                      </div>
                    ))}
                  </div>
                </section>
              )}

              <section className="bg-white rounded-2xl shadow p-5 border">
                <div className="flex items-center justify-between">
                  <h2 className="text-lg font-semibold mb-2">Pruebas automáticas</h2>
                  <button onClick={runTests} className="px-3 py-2 rounded-2xl shadow bg-white hover:bg-slate-100 border">Ejecutar tests</button>
                </div>
                {Array.isArray(testResults) && (
                  <ul className="mt-3 grid md:grid-cols-2 gap-2 text-sm">
                    {testResults.map((t, i) => (
                      <li key={i} className={`border rounded-xl px-3 py-2 ${t.pass ? "bg-emerald-50" : "bg-red-50"}`}>
                        <div className="font-medium">{t.name}</div>
                        <div>Resultado: {t.got.toFixed(2)}% | Esperado: {t.expected.toFixed(2)}%</div>
                        <div className="text-xs">{t.pass ? "OK" : "FALLÓ"}</div>
                      </li>
                    ))}
                  </ul>
                )}
              </section>

              <section className="bg-white rounded-2xl shadow p-5 border">
                <h2 className="text-lg font-semibold mb-2">Notas rápidas y referencias</h2>
                <ul className="list-disc pl-6 space-y-1 text-sm text-slate-700">
                  <li>Ingresá el valor base de un score validado (SCORE2, PCE, MESA). Esta app sólo aplica multiplicadores.</li>
                  <li><span className="font-medium">CAC=0</span> suele asociarse a menor riesgo a corto/mediano plazo; categorías crecientes de CAC elevan el riesgo relativo.</li>
                  <li>Depresión y ansiedad clínicas se asocian con incremento de riesgo CV; los valores aquí son conservadores y ajustables.</li>
                  <li>Historia de cáncer con antraciclinas o radioterapia mediastinal eleva riesgo CV a largo plazo; considerar prevención intensiva.</li>
                </ul>
              </section>

              <footer className="text-xs text-slate-500 pt-2">
                © {new Date().getFullYear()} – Uso educativo. No reemplaza guías clínicas ni juicio profesional.
              </footer>
            </div>
          </div>
        );
      }

      ReactDOM.createRoot(document.getElementById("root")).render(<App />);
    </script>
  </body>
</html>
