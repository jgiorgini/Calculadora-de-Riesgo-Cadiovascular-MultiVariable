<!doctype html>
<html lang="es" class="h-full">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Integrador de Riesgo CV</title>
    <meta name="description" content="Calculadora integradora de riesgo cardiovascular con ajuste por ateromatosis subclínica, factores psicosociales y antecedentes oncológicos." />
    <script>
      tailwind = window.tailwind || {};
      tailwind.config = { darkMode: 'class' };
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      :root { --radius: 16px; }
      .card { border-radius: var(--radius); }
      .btn { padding: 0.75rem 1rem; border-radius: 9999px; }
      @media (max-width: 480px) {
        html { font-size: 17px; }
        .stack > * { width: 100%; }
        .btn { padding: 0.75rem 1rem; border-radius: 9999px; }
      }
      @media print {
        body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
        .no-print { display: none !important; }
        .print-area, .print-area * { visibility: visible !important; }
        body *:not(.print-area):not(.print-area *) { visibility: hidden !important; }
        .print-area { position: absolute; inset: 0; padding: 24px; background: white; }
      }
      .icon-info { fill: currentColor; }
    </style>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  </head>
  <body class="bg-slate-50 h-full">
    <div id="root"></div>

    <script type="text/babel">
      const { useMemo, useState, useEffect } = React;

      const clamp = (x, min, max) => Math.min(Math.max(x, min), max);
      const toNumber = (v, fallback = 0) => { const n = typeof v === "number" ? v : parseFloat(String(v)); return Number.isFinite(n) ? n : fallback; };
      const pretty = (x) => `${toNumber(x, 0).toFixed(1)}%`;
      const normalizeCAC = (v) => { const s = String(v).trim(); if (s === "0") return "0"; if (s === "1_99" || s === "1-99") return "1_99"; if (s === "100_299" || s === "100-299") return "100_299"; if (s === "300_plus" || s === "300+" || s === ">=300" || s === "≥300") return "300_plus"; return "unknown"; };
      const categorizeLabel = (r) => (r < 5 ? "Bajo" : r < 10 ? "Límite" : r < 20 ? "Intermedio" : "Alto");

      const defaultState = {
        baseRisk: 0,
        baseSource: "SCORE2 (ESC 2021)",
        postalCode: "",
        education: "university",
        cac: "unknown",
        territories: 0,
        psychosocial: { depression: "none", anxiety: "none" },
        oncology: "none",
        multipliers: {
          cac_unknown: 1.0, cac_0: 0.70, cac_1_99: 1.5, cac_100_299: 2.2, cac_300_plus: 3.0,
          terr_0: 1.00, terr_1: 1.25, terr_2: 1.45, terr_3: 1.65, terr_4: 1.85,
          dep_none: 1.0, dep_mild: 1.15, dep_major: 1.30,
          anx_none: 1.0, anx_clinical: 1.20,
          onco_none: 1.0, onco_noncardio: 1.15, onco_cardio: 1.40,
          social_none: 1.0,
          social_low_income: 1.2,
          edu_university: 1.0, edu_secondary_complete: 1.15, edu_secondary_incomplete: 1.25, edu_primary: 1.40,
        },
      };

      const SOURCE_OPTIONS = [
        "SCORE2 (ESC 2021)",
        "PCE (Pooled Cohort Equations, ACC/AHA)",
        "MESA (CHD risk)",
        "HEARTS / OPS (OMS 2019)",
        "PREVENT (AHA 2023)",
        "Otro…"
      ];

      const BIBLIO = [
        { key: "detrano2008", title: "Coronary Calcium as a Predictor of Coronary Events in Four Racial or Ethnic Groups", authors: "Detrano R, et al.", journal: "N Engl J Med", year: 2008, url: "https://doi.org/10.1056/NEJMoa0706280", doi: "10.1056/NEJMoa0706280", tags: ["CAC","MESA","pronóstico"], citation: "Detrano R, et al. N Engl J Med. 2008;358:1336-1345." },
        { key: "bioimage2015", title: "Prevalence, Impact, and Predictive Value of Detecting SA by Carotid Plaque Burden and CAC (BioImage)", authors: "Baber U, et al.", journal: "J Am Coll Cardiol", year: 2015, url: "https://pubmed.ncbi.nlm.nih.gov/25790876/", doi: "", tags: ["cPB","CAC","reclasificación","eventos"], citation: "Baber U, et al. J Am Coll Cardiol. 2015;65:1065–1074." },
        { key: "pesa2015", title: "Prevalence & Multiterritorial Extent of SA (PESA)", authors: "Fernández-Friera L, et al.", journal: "Circulation", year: 2015, url: "https://doi.org/10.1161/CIRCULATIONAHA.114.014310", doi: "10.1161/CIRCULATIONAHA.114.014310", tags: ["PESA","multiterritorial"], citation: "Fernández-Friera L, et al. Circulation. 2015;131:2104–2113." },
        { key: "pesa3d2017", title: "Subclinical Atherosclerosis Burden by 3D Ultrasound in Mid-Life", authors: "López-Melgar B, et al.", journal: "J Am Coll Cardiol", year: 2017, url: "https://www.jacc.org/doi/10.1016/j.jacc.2017.05.033", doi: "10.1016/j.jacc.2017.05.033", tags: ["3D VUS","burden"], citation: "López-Melgar B, et al. J Am Coll Cardiol. 2017;70:301–313." },
        { key: "mehta2021", title: "Association of Carotid Artery Plaque With Cardiovascular Events", authors: "Mehta A, et al.", journal: "Circ Cardiovasc Imaging", year: 2021, url: "https://www.ahajournals.org/doi/10.1161/CIRCIMAGING.120.011701", doi: "10.1161/CIRCIMAGING.120.011701", tags: ["carótida","eventos"], citation: "Mehta A, et al. Circ Cardiovasc Imaging. 2021;14:e011701." },
        { key: "review2023", title: "Assessment of subclinical atherosclerosis in asymptomatic adults (Review)", authors: "Garg P, et al.", journal: "Atherosclerosis Thromb Vasc Biol", year: 2023, url: "https://pmc.ncbi.nlm.nih.gov/articles/PMC10753091/", doi: "", tags: ["revisión","subclínica","ultrasonido"], citation: "Garg P, et al. ATVB. 2023;43:1868–1887." },
        { key: "esc_cardio_onco_2022", title: "2022 ESC Guidelines on cardio-oncology", authors: "Lyon AR, et al.", journal: "Eur Heart J", year: 2022, url: "https://academic.oup.com/eurheartj/article/43/41/4229/6673995", doi: "10.1093/eurheartj/ehac244", tags: ["cardio-oncología","guías"], citation: "Lyon AR, et al. Eur Heart J. 2022;43:4229–4361." },
        { key: "prevent_calc", title: "PREVENT Online Calculator", authors: "American Heart Association", journal: "Professional Heart Daily", year: 2023, url: "https://professional.heart.org/en/guidelines-and-statements/prevent-risk-calculator/prevent-calculator", doi: "", tags: ["PREVENT","calculadora"], citation: "American Heart Association. PREVENT Online Calculator. 2023. Professional Heart Daily." },
        { key: "prevent_paper", title: "Development and Validation of the AHA PREVENT Equations", authors: "Khan SS, Matsushita K, Sang Y, et al.", journal: "Circulation", year: 2024, url: "https://www.ahajournals.org/doi/10.1161/CIRCULATIONAHA.123.067626", doi: "10.1161/CIRCULATIONAHA.123.067626", tags: ["PREVENT","modelo"], citation: "Khan SS, Matsushita K, Sang Y, et al. Development and Validation of the AHA PREVENT Equations. Circulation. 2024;149(6):430-449." }
      ];

      function InfoIcon({ text, bibKeys = [] }) {
        const [show, setShow] = useState(false);
        const ref = React.useRef(null);
        useEffect(() => {
          function handleClickOutside(event) { if (ref.current && !ref.current.contains(event.target)) setShow(false); }
          document.addEventListener("mousedown", handleClickOutside);
          return () => document.removeEventListener("mousedown", handleClickOutside);
        }, [ref]);
        const bibItems = useMemo(() => BIBLIO.filter(b => bibKeys.includes(b.key)), [bibKeys]);
        return (
          <div className="relative inline-block" ref={ref}>
            <button onClick={() => setShow(!show)} className="p-1 -m-1 inline-flex items-center text-slate-500 dark:text-slate-400">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="icon-info">
                <circle cx="12" cy="12" r="10" />
                <path d="M12 16v-4" />
                <path d="M12 8h.01" />
              </svg>
            </button>
            {show && (
              <div className="absolute left-1/2 -translate-x-1/2 bottom-full z-10 w-80 p-3 mb-2 rounded-xl shadow-xl bg-white dark:bg-slate-800 border text-sm text-slate-900 dark:text-slate-100">
                <p className="mb-2">{text}</p>
                {bibItems.length > 0 && (
                  <div className="space-y-1">
                    <span className="font-semibold">Referencias:</span>
                    {bibItems.map((b) => (
                      <div key={b.key} className="text-xs">
                        <div className="font-medium">{b.authors.split(",")[0].trim()} et al. ({b.year})</div>
                        <div>"{b.title}"</div>
                      </div>
                    ))}
                  </div>
                )}
                <div className="absolute bottom-[-6px] left-1/2 -translate-x-1/2 w-3 h-3 bg-white dark:bg-slate-800 rotate-45 border-b border-r" />
              </div>
            )}
          </div>
        );
      }

      function App() {
        const [s, setS] = useState(() => {
          try {
            const raw = window.localStorage?.getItem("cv_risk_integrator_state_v2");
            const parsed = raw ? JSON.parse(raw) : {};
            const safe = { ...defaultState, ...parsed };
            // Aseguramos que los valores que se muestran en los inputs se reinicien
            safe.baseRisk = 0;
            safe.postalCode = "";
            safe.education = "university";
            safe.cac = "unknown";
            safe.territories = 0;
            safe.psychosocial = { depression: "none", anxiety: "none" };
            safe.oncology = "none";
            const mm = { ...defaultState.multipliers, ...(safe.multipliers || {}) };
            for (const k of Object.keys(mm)) mm[k] = toNumber(mm[k], defaultState.multipliers[k]);
            safe.multipliers = mm;
            return safe;
          } catch { return defaultState; }
        });

        const [dark, setDark] = useState(() => {
          try {
            const saved = window.localStorage.getItem("cv_risk_ui_dark");
            if (saved === "true" || saved === "false") return JSON.parse(saved);
          } catch {}
          return false;
        });
        useEffect(() => {
          try { window.localStorage.setItem("cv_risk_ui_dark", JSON.stringify(dark)); } catch {}
          document.documentElement.classList.toggle("dark", !!dark);
        }, [dark]);

        const [baseRiskInput, setBaseRiskInput] = useState(String(defaultState.baseRisk));
        const [showAdvanced, setShowAdvanced] = useState(false);
        const [showBib, setShowBib] = useState(false);
        const [showAbout, setShowAbout] = useState(false);
        const [bibQuery, setBibQuery] = useState("");
        const [testResults, setTestResults] = useState(null);
        const [extResults, setExtResults] = useState(null);

        const [profiles, setProfiles] = useState(() => { try { const raw = window.localStorage.getItem("cv_risk_profiles_v2"); return raw ? JSON.parse(raw) : []; } catch { return []; } });
        const [profileName, setProfileName] = useState("");
        
        useEffect(() => {
          try {
            const { baseRisk, ...rest } = s;
            window.localStorage?.setItem("cv_risk_integrator_state_v2", JSON.stringify(rest));
          } catch {}
        }, [s]);

        const onBaseRiskChange = (val) => {
          setBaseRiskInput(val);
          const normalized = String(val).replace(",", ".").trim();
          const num = parseFloat(normalized);
          if (Number.isFinite(num)) {
            const clamped = clamp(num, 0, 60);
            if (clamped !== s.baseRisk) setS({ ...s, baseRisk: clamped });
          }
        };

        const onPostalCodeChange = (val) => {
          const postalCode = String(val).trim().toUpperCase();
          setS({ ...s, postalCode });
        };
        
        const onEducationChange = (val) => {
          setS({ ...s, education: val });
        };

        async function pastePercentFromClipboard() {
          try {
            const text = await navigator.clipboard.readText();
            const m = text.match(/(\d+[\.,]?\d*)\s*%?/);
            if (m) {
              const raw = m[1].replace(",", ".");
              const v = clamp(parseFloat(raw), 0, 60);
              if (Number.isFinite(v)) {
                setBaseRiskInput(String(v));
                setS({ ...s, baseRisk: v });
              }
            }
          } catch {}
        }

        function calcWith(overrides) {
          const st = { ...s, psychosocial: { ...s.psychosocial }, ...overrides };
          const m = { ...s.multipliers, ...(overrides?.multipliers || {}) };
          let cac = 1.0;
          switch (normalizeCAC(st.cac)) {
            case "0": cac = m.cac_0; break;
            case "1_99": cac = m.cac_1_99; break;
            case "100_299": cac = m.cac_100_299; break;
            case "300_plus": cac = m.cac_300_plus; break;
            default: cac = m.cac_unknown; break;
          }
          const t = clamp(parseInt(st.territories || 0, 10) || 0, 0, 4);
          const terr = toNumber(m[`terr_${t}`], 1.0);
          const athero = toNumber(cac, 1.0) * toNumber(terr, 1.0);
          const dep = st.psychosocial.depression === "mild" ? m.dep_mild : st.psychosocial.depression === "major" ? m.dep_major : m.dep_none;
          const anx = st.psychosocial.anxiety === "clinical" ? m.anx_clinical : m.anx_none;
          const psych = clamp(toNumber(dep, 1.0) * toNumber(anx, 1.0), 1.0, 1.6);
          const onco = st.oncology === "cancer_noncardiotox" ? m.onco_noncardio : st.oncology === "anthracycline_or_rt" ? m.onco_cardio : m.onco_none;
          const social = st.postalCode === "C1142" || st.postalCode === "1142" ? toNumber(m.social_low_income, 1.2) : toNumber(m.social_none, 1.0);
          const education = toNumber(m[`edu_${st.education}`], 1.0);
          const comp = toNumber(athero, 1.0) * toNumber(psych, 1.0) * toNumber(onco, 1.0) * toNumber(social, 1.0) * toNumber(education, 1.0);
          const base = clamp(Number(st.baseRisk) || 0, 0, 60);
          const adj = clamp(base * comp, 0, 95);
          return { base, comp, adj, athero, cac, terr, psych, onco, social, education };
        }

        const { base, comp, adj, athero, cac, terr, psych, onco, social, education } = useMemo(() => calcWith({}), [s]);

        const category = useMemo(() => {
          const r = adj;
          if (r < 5) return { label: "Bajo", color: "bg-emerald-100 text-emerald-900" };
          if (r < 10) return { label: "Límite", color: "bg-yellow-100 text-yellow-900" };
          if (r < 20) return { label: "Intermedio", color: "bg-orange-100 text-orange-900" };
          return { label: "Alto", color: "bg-red-100 text-red-900" };
        }, [adj]);

        const baseCategory = useMemo(() => categorizeLabel(base), [base]);
        const reclassification = useMemo(() => {
          const adjLabel = categorizeLabel(adj);
          if (adjLabel === baseCategory) return `No hay cambio de categoría`;
          return `Reclasificado de "${baseCategory}" a "${adjLabel}"`;
        }, [adj, baseCategory]);

        const reset = () => { 
          setS(defaultState); 
          setBaseRiskInput(String(defaultState.baseRisk)); 
          window.localStorage.removeItem("cv_risk_integrator_state_v2");
          setProfiles([]);
          window.localStorage.removeItem("cv_risk_profiles_v2");
        };

        function printPDF() { window.print(); }

        const presets = {
          conservador: { label: "Conservador", vals: { cac_1_99: 1.4, cac_100_299: 2.0, cac_300_plus: 2.7, dep_mild: 1.10, dep_major: 1.25, anx_clinical: 1.15, onco_noncardio: 1.10, onco_cardio: 1.30, terr_1: 1.20, terr_2: 1.35, terr_3: 1.50, terr_4: 1.70, social_low_income: 1.1, edu_secondary_complete: 1.1, edu_secondary_incomplete: 1.2, edu_primary: 1.3 } },
          base:        { label: "Base (actual)", vals: {} },
          intensivo:   { label: "Intensivo", vals: { cac_1_99: 1.6, cac_100_299: 2.5, cac_300_plus: 3.5, dep_mild: 1.20, dep_major: 1.40, anx_clinical: 1.25, onco_noncardio: 1.20, onco_cardio: 1.55, terr_1: 1.30, terr_2: 1.50, terr_3: 1.70, terr_4: 1.90, social_low_income: 1.3, edu_secondary_complete: 1.2, edu_secondary_incomplete: 1.3, edu_primary: 1.5 } },
        };
        function applyPreset(key) { const p = presets[key]; if (!p) return; setS((old) => ({ ...old, multipliers: { ...old.multipliers, ...p.vals } })); }

        function saveProfile() { const entry = { name: profileName || `Paciente ${profiles.length + 1}`, state: s }; const next = [entry, ...profiles].slice(0, 50); setProfiles(next); try { window.localStorage.setItem("cv_risk_profiles_v2", JSON.stringify(next)); } catch {} setProfileName(""); }
        function loadProfile(idx) { const p = profiles[idx]; if (!p) return; setS(p.state); setBaseRiskInput(String(p.state?.baseRisk ?? 0)); }
        function deleteProfile(idx) { const next = profiles.filter((_, i) => i !== idx); setProfiles(next); try { window.localStorage.setItem("cv_risk_profiles_v2", JSON.stringify(next)); } catch {} }

        function runTests() {
          const baseCases = [
            { name: "Sin modificadores", cfg: { baseRisk: 10, psychosocial: { depression: "none", anxiety: "none" }, oncology: "none", cac:"unknown", territories:0, postalCode: "", education: "university" }, expectAdj: 10.0 },
            { name: "CAC=0 reduce", cfg: { baseRisk: 10, cac: "0", territories: 0 }, expectAdj: 7.0 },
            { name: "CAC 100–299 eleva", cfg: { baseRisk: 10, cac: "100_299", territories: 0 }, expectAdj: 22.0 },
            { name: "Psicosocial mayor + ansiedad clínica", cfg: { baseRisk: 10, psychosocial: { depression: "major", anxiety: "clinical" } }, expectAdj: 15.6 },
            { name: "Onco cardiotóxicos", cfg: { baseRisk: 10, oncology: "anthracycline_or_rt" }, expectAdj: 14.0 },
            { name: "Territorios = 2", cfg: { baseRisk: 10, territories: 2 }, expectAdj: 14.5 },
            { name: "Contexto social bajo ingreso", cfg: { baseRisk: 10, postalCode: "1142" }, expectAdj: 12.0 },
            { name: "Educación primaria", cfg: { baseRisk: 10, education: "primary" }, expectAdj: 14.0 },
            { name: "Combinado fuerte (CAC300+, Terr=3, onco, edu)", cfg: { baseRisk: 8, cac: "300_plus", territories: 3, psychosocial: { depression: "major", anxiety: "none" }, oncology: "anthracycline_or_rt", education: "secondary_incomplete" }, expectAdj: 91.0 },
          ];
          const results = baseCases.map((t) => {
            const merged = { ...defaultState, ...t.cfg };
            merged.multipliers = { ...defaultState.multipliers, ...(t.cfg.multipliers || {}) };
            const r = calcWith(merged);
            const pass = Math.abs(r.adj - t.expectAdj) < 0.11;
            return { name: t.name, got: r.adj, expected: t.expectAdj, pass };
          });
          setTestResults(results);
        }

        function runExtendedTests() {
          const results = [];
          const catCases = [{r:4.9,expect:"Bajo"},{r:5.0,expect:"Límite"},{r:9.9,expect:"Límite"},{r:10.0,expect:"Intermedio"},{r:19.9,expect:"Intermedio"},{r:20.0,expect:"Alto"}];
          for (const c of catCases) { const got = categorizeLabel(c.r); results.push({ name: `Categoría @ ${c.r}%`, got, expected: c.expect, pass: got === c.expect }); }
          const bases = [0,1,5,10,30,60]; const vals = bases.map((b)=>calcWith({baseRisk:b, territories:0, cac:"unknown", psychosocial:{depression:"none",anxiety:"none"}, oncology:"none"}).adj);
          let mono = true; for (let i=1;i<vals.length;i++) if (vals[i] < vals[i-1] - 1e-9) mono=false;
          results.push({ name: "Monotonicidad baseRisk", got: mono ? "no decrece" : "decreció", expected: "no decrece", pass: mono });
          const base = 10;
          const neutral = { territories:0, psychosocial:{depression:"none",anxiety:"none"}, oncology:"none" };
          const rUnknown = calcWith({ ...neutral, baseRisk: base, cac: "unknown" }).adj;
          const r0 = calcWith({ ...neutral, baseRisk: base, cac: "0" }).adj;
          const r1 = calcWith({ ...neutral, baseRisk: base, cac: "1_99" }).adj;
          const r100 = calcWith({ ...neutral, baseRisk: base, cac: "100_299" }).adj;
          const r300 = calcWith({ ...neutral, baseRisk: base, cac: "300_plus" }).adj;
          const okCAC = Math.abs(rUnknown - base) < 1e-9 && r0 < r1 && r1 < r100 && r100 < r300;
          results.push({ name: "Orden CAC", got: `${r0.toFixed(1)} < ${r1.toFixed(1)} < ${r100.toFixed(1)} < ${r300.toFixed(1)} (unknown≈${rUnknown.toFixed(1)})`, expected: "0 < 1_99 < 100_299 < 300_plus; unknown=base", pass: okCAC });
          const rT = [0,1,2,3,4].map(t=>calcWith({ baseRisk: 10, territories: t, cac:"unknown", psychosocial:{depression:"none",anxiety:"none"}, oncology:"none" }).adj);
          let terrMono = true; for (let i=1;i<rT.length;i++) if (rT[i] < rT[i-1] - 1e-9) terrMono=false;
          results.push({ name: "Orden territorios (0→4)", got: rT.map(v=>v.toFixed(1)).join(" < "), expected: "monótono creciente", pass: terrMono });
          setExtResults(results);
        }

        return (
          <div className="min-h-screen w-full bg-slate-50 dark:bg-slate-900 dark:text-slate-100 text-slate-900 p-4 md:p-6">
            <div className="max-w-4xl mx-auto space-y-6">
              <header className="flex items-center justify-between">
                <h1 className="text-2xl md:text-3xl font-semibold tracking-tight">Integrador de Riesgo CV</h1>
                <div className="flex flex-wrap gap-2 items-center no-print stack">
                  <button onClick={() => setShowBib(true)} className="btn px-3 py-2 rounded-2xl shadow bg-white dark:bg-slate-800 hover:bg-slate-100 border">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="icon-info inline-block mr-2"><path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20"/></svg>
                    Bibliografía
                  </button>
                  <button onClick={() => setShowAbout(true)} className="btn px-3 py-2 rounded-2xl shadow bg-white dark:bg-slate-800 hover:bg-slate-100 border">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="icon-info inline-block mr-2"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><path d="M12 17h.01"/></svg>
                    Acerca
                  </button>
                  <button title="Editar multiplicadores (CAC, territorios, psicosocial, onco)" onClick={() => setShowAdvanced((v) => !v)} className="btn px-3 py-2 rounded-2xl shadow bg-white dark:bg-slate-800 hover:bg-slate-100 border">{showAdvanced ? "Ocultar" : "Avanzado"}</button>
                  <button onClick={() => setDark((v) => !v)} className="btn px-3 py-2 rounded-2xl shadow bg-white dark:bg-slate-800 hover:bg-slate-100 border">{dark ? "Claro" : "Oscuro"}</button>
                  <button onClick={printPDF} className="btn px-3 py-2 rounded-2xl shadow bg-white dark:bg-slate-800 hover:bg-slate-100 border">PDF</button>
                  <button onClick={reset} className="btn px-3 py-2 rounded-2xl shadow bg-white dark:bg-slate-800 hover:bg-slate-100 border">Reiniciar</button>
                </div>
              </header>

              <p className="text-sm text-slate-600 dark:text-slate-300 leading-relaxed">
                Ingresá el <span className="font-medium">riesgo base a 10 años</span> obtenido de un score validado (SCORE2, <abbr title="Pooled Cohort Equations (ACC/AHA)">PCE</abbr>, PREVENT, MESA, u <em>HEARTS/OPS</em>). Luego, aplicá ajustes por
                <span className="font-medium"> ateromatosis subclínica</span>, <span className="font-medium">depresión/ansiedad</span> y <span className="font-medium">antecedentes oncológicos</span>.
                Esta herramienta es educativa y no reemplaza el juicio clínico.
              </p>

              <div className="grid md:grid-cols-2 gap-6">
                <section className="card bg-white dark:bg-slate-800 shadow p-4 space-y-4 border">
                  <h2 className="text-lg font-semibold">1) Riesgo base</h2>

                  <label className="block text-sm">Fuente</label>
                  <div className="flex flex-wrap gap-2 items-center">
                    <select
                      className="border rounded-xl px-3 py-2 dark:bg-slate-900"
                      value={s.baseSource}
                      onChange={(e) => setS({ ...s, baseSource: e.target.value })}
                    >
                      {SOURCE_OPTIONS.map(opt => <option key={opt} value={opt}>{opt}</option>)}
                    </select>

                    {s.baseSource.startsWith("HEARTS") && (
                      <a className="px-3 py-2 rounded-2xl border" href="https://www.paho.org/cardioapp/web/#/cvrisk" target="_blank" rel="noreferrer noopener">Abrir HEARTS</a>
                    )}
                    {s.baseSource.startsWith("PREVENT") && (
                      <a className="px-3 py-2 rounded-2xl border" href="https://professional.heart.org/en/guidelines-and-statements/prevent-risk-calculator/prevent-calculator" target="_blank" rel="noreferrer noopener">Abrir PREVENT</a>
                    )}
                    <button onClick={pastePercentFromClipboard} className="px-3 py-2 rounded-2xl border">
                      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="inline-block mr-1"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/></svg>
                      Pegar %
                    </button>
                  </div>

                  <div className="grid md:grid-cols-2 gap-4">
                    <div>
                      <label className="block text-sm mt-2">Riesgo a 10 años (%)</label>
                      <input
                        type="text" inputMode="decimal" placeholder="Ej.: 7.5"
                        className="w-full border rounded-xl px-3 py-2 dark:bg-slate-900"
                        value={baseRiskInput}
                        onChange={(e) => onBaseRiskChange(e.target.value)}
                      />
                    </div>
                    <div>
                      <label className="block text-sm mt-2">Código postal (opcional)</label>
                      <input
                        type="text" placeholder="Ej.: C1142"
                        className="w-full border rounded-xl px-3 py-2 dark:bg-slate-900"
                        value={s.postalCode}
                        onChange={(e) => onPostalCodeChange(e.target.value)}
                      />
                    </div>
                  </div>
                  <div className="grid grid-cols-1 gap-4">
                    <div>
                      <label className="block text-sm">
                        Nivel de escolaridad
                      </label>
                      <select className="w-full border rounded-xl px-3 py-2 dark:bg-slate-900" value={s.education} onChange={(e) => onEducationChange(e.target.value)}>
                        <option value="university">Universitario/Terciario (completo)</option>
                        <option value="secondary_complete">Secundario (completo) o Terciario (incompleto)</option>
                        <option value="secondary_incomplete">Secundario (incompleto)</option>
                        <option value="primary">Primario (completo o incompleto) o sin escolaridad</option>
                      </select>
                    </div>
                  </div>
                </section>

                <section className="card bg-white dark:bg-slate-800 shadow p-4 space-y-4 border">
                  <h2 className="text-lg font-semibold">2) Ateromatosis subclínica</h2>
                  <div className="grid gap-3">
                    <div>
                      <label className="block text-sm">
                        CAC (categoría)
                        <InfoIcon text="El score de calcio coronario (CAC) es un fuerte predictor de eventos cardiovasculares. Un CAC de 0 tiene un valor pronóstico protector. Un CAC elevado recalifica el riesgo al alza." bibKeys={["detrano2008"]} />
                      </label>
                      <select className="w-full border rounded-xl px-3 py-2 dark:bg-slate-900" value={s.cac} onChange={(e) => setS({ ...s, cac: normalizeCAC(e.target.value) })}>
                        <option value="unknown">Desconocido</option>
                        <option value="0">0</option>
                        <option value="1_99">1–99</option>
                        <option value="100_299">100–299</option>
                        <option value="300_plus">≥300</option>
                      </select>
                    </div>
                    <div>
                      <label className="block text-sm">
                        Territorios con placa
                        <InfoIcon text="La presencia de placas ateroscleróticas en múltiples territorios vasculares (carótidas, aorta, femorales) indica mayor carga aterosclerótica y aumenta el riesgo cardiovascular. Basado en evidencia de estudios como PESA y BioImage." bibKeys={["pesa2015", "bioimage2015"]} />
                      </label>
                      <select className="w-full border rounded-xl px-3 py-2 dark:bg-slate-900" value={s.territories} onChange={(e) => setS({ ...s, territories: clamp(parseInt(e.target.value,10)||0,0,4) })}>
                        <option value="0">0</option>
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                      </select>
                    </div>
                  </div>
                  <div className="text-sm text-slate-600 dark:text-slate-300">Multiplicador ateromatosis: <span className="font-semibold">× {toNumber(athero,1).toFixed(2)}</span> (CAC: ×{toNumber(cac,1).toFixed(2)}, Terr: ×{toNumber(terr,1).toFixed(2)})</div>
                </section>
              </div>

              <div className="grid md:grid-cols-2 gap-6 mt-6">
                <section className="card bg-white dark:bg-slate-800 shadow p-4 space-y-4 border">
                  <h2 className="text-lg font-semibold">3) Psicosocial</h2>
                  <div className="grid grid-cols-2 gap-4">
                    <div>
                      <label className="block text-sm">Depresión</label>
                      <select className="w-full border rounded-xl px-3 py-2 dark:bg-slate-900" value={s.psychosocial.depression} onChange={(e) => setS({ ...s, psychosocial: { ...s.psychosocial, depression: e.target.value } })}>
                        <option value="none">Ninguna</option>
                        <option value="mild">Leve/estable</option>
                        <option value="major">Mayor/activa</option>
                      </select>
                    </div>
                    <div>
                      <label className="block text-sm">Ansiedad</label>
                      <select className="w-full border rounded-xl px-3 py-2 dark:bg-slate-900" value={s.psychosocial.anxiety} onChange={(e) => setS({ ...s, psychosocial: { ...s.psychosocial, anxiety: e.target.value } })}>
                        <option value="none">Ninguna</option>
                        <option value="clinical">Clínica</option>
                      </select>
                    </div>
                  </div>
                  <div className="text-sm text-slate-600 dark:text-slate-300">Multiplicador psicosocial: <span className="font-semibold">× {toNumber(psych, 1).toFixed(2)}</span></div>
                </section>

                <section className="card bg-white dark:bg-slate-800 shadow p-4 space-y-4 border">
                  <h2 className="text-lg font-semibold">4) Antecedentes oncológicos</h2>
                  <label className="block text-sm">
                    Antecedente oncológico y tratamiento
                    <InfoIcon text="Muchos tratamientos contra el cáncer, especialmente la quimioterapia con antraciclinas y la radioterapia en el tórax, tienen efectos cardiotóxicos que aumentan el riesgo cardiovascular a largo plazo." bibKeys={["esc_cardio_onco_2022"]} />
                  </label>
                  <select className="w-full border rounded-xl px-3 py-2 dark:bg-slate-900" value={s.oncology} onChange={(e) => setS({ ...s, oncology: e.target.value })}>
                    <option value="none">Ninguno</option>
                    <option value="cancer_noncardiotox">Cáncer previo (sin cardiotóxicos)</option>
                    <option value="anthracycline_or_rt">Antraciclinas o RT mediastinal</option>
                  </select>
                  <div className="text-sm text-slate-600 dark:text-slate-300">Multiplicador onco: <span className="font-semibold">× {toNumber(onco, 1).toFixed(2)}</span></div>
                </section>
              </div>

              <section className="card bg-white dark:bg-slate-800 shadow p-5 border print-area mt-6">
                <h2 className="text-lg font-semibold mb-3">Resultado</h2>
                <div className="grid md:grid-cols-3 gap-4 items-stretch">
                  <div className="border rounded-2xl p-4 bg-slate-50 dark:bg-slate-900">
                    <div className="text-xs uppercase tracking-wide text-slate-500 dark:text-slate-400">Riesgo base</div>
                    <div className="text-3xl font-semibold">{pretty(base)}</div>
                    <div className="text-xs text-slate-500 dark:text-slate-400">Fuente: {s.baseSource || "(—)"} | Cat.: {baseCategory}</div>
                  </div>
                  <div className="border rounded-2xl p-4 bg-slate-50 dark:bg-slate-900">
                    <div className="text-xs uppercase tracking-wide text-slate-500 dark:text-slate-400">Multiplicador compuesto</div>
                    <div className="text-3xl font-semibold">× {toNumber(comp, 1).toFixed(2)}</div>
                    <div className="text-xs text-slate-500 dark:text-slate-400">Atero × Psico × Onco × Social × Educación</div>
                  </div>
                  <div className={`border rounded-2xl p-4 ${category.color}`}>
                    <div className="text-xs uppercase tracking-wide">Riesgo ajustado</div>
                    <div className="text-3xl font-semibold">{pretty(adj)}</div>
                    <div className="text-xs">Categoría: {category.label}</div>
                  </div>
                </div>
                <div className="mt-4 text-sm text-center font-medium">
                  {reclassification}
                </div>
              </section>

              <section className="card bg-white dark:bg-slate-800 shadow p-5 border mt-6 no-print">
                <div className="flex items-center justify-between">
                  <h2 className="text-lg font-semibold mb-2">Pacientes guardados</h2>
                  <button onClick={saveProfile} className="btn px-3 py-2 rounded-2xl shadow border flex-shrink-0">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="inline-block mr-1"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
                    Guardar paciente
                  </button>
                </div>
                <div className="mt-2 text-sm text-slate-600 dark:text-slate-300">
                  <input
                    type="text" placeholder="Nombre del paciente (opcional)"
                    className="w-full border rounded-xl px-3 py-2 dark:bg-slate-900"
                    value={profileName}
                    onChange={(e) => setProfileName(e.target.value)}
                    onKeyDown={(e) => { if (e.key === 'Enter') saveProfile(); }}
                  />
                  <div className="mt-2 text-xs">Los datos se guardan en tu navegador.</div>
                </div>
                {profiles.length > 0 && (
                  <ul className="mt-3 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2 text-sm">
                    {profiles.map((p, i) => (
                      <li key={i} className="flex items-center justify-between gap-2 border rounded-xl px-3 py-2 bg-slate-50 dark:bg-slate-900">
                        <span className="truncate">{p.name}</span>
                        <div className="flex items-center gap-1">
                          <button onClick={() => loadProfile(i)} className="px-2 py-1 rounded-lg border">Cargar</button>
                          <button onClick={() => deleteProfile(i)} className="px-2 py-1 rounded-lg border text-red-500">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>
                          </button>
                        </div>
                      </li>
                    ))}
                  </ul>
                )}
              </section>

              {showAdvanced && (
                <section className="card bg-white dark:bg-slate-800 shadow p-5 space-y-4 border mt-6">
                  <div className="flex items-center justify-between flex-wrap gap-2">
                    <h2 className="text-lg font-semibold">Ajustes avanzados (editar multiplicadores)</h2>
                    <div className="flex items-center gap-2 text-sm no-print">
                      <span>Presets RR:</span>
                      <button onClick={() => applyPreset("conservador")} className="px-2 py-1 rounded-xl border">Conservador</button>
                      <button onClick={() => applyPreset("base")} className="px-2 py-1 rounded-xl border">Base</button>
                      <button onClick={() => applyPreset("intensivo")} className="px-2 py-1 rounded-xl border">Intensivo</button>
                    </div>
                  </div>
                  <p className="text-sm text-slate-600 dark:text-slate-300">Personalizá los RR (incluido el efecto por territorios). Los cambios persisten localmente.</p>

                  <div className="grid md:grid-cols-3 gap-4 text-sm">
                    {Object.entries(s.multipliers).map(([key, val]) => (
                      <div key={key} className="flex items-center justify-between gap-2 border rounded-xl px-3 py-2">
                        <span className="font-mono text-xs">{key}</span>
                        <input
                          type="number" step={0.01}
                          className="w-24 border rounded-lg px-2 py-1 dark:bg-slate-900"
                          value={toNumber(val, toNumber(defaultState.multipliers[key], 1))}
                          onChange={(e) => {
                            const num = toNumber(e.target.value, toNumber(defaultState.multipliers[key], 1));
                            setS({ ...s, multipliers: { ...s.multipliers, [key]: num } });
                          }}
                        />
                      </div>
                    ))}
                  </div>
                </section>
              )}

              <section className="card bg-white dark:bg-slate-800 shadow p-5 border mt-6">
                <div className="flex items-center justify-between no-print">
                  <h2 className="text-lg font-semibold mb-2">Pruebas automáticas</h2>
                  <div className="flex gap-2">
                    <button onClick={runTests} className="px-3 py-2 rounded-2xl shadow bg-white dark:bg-slate-900 hover:bg-slate-100 border">Ejecutar tests</button>
                    <button onClick={runExtendedTests} className="px-3 py-2 rounded-2xl shadow bg-white dark:bg-slate-900 hover:bg-slate-100 border">Validación extendida</button>
                  </div>
                </div>
                <p className="text-sm text-slate-600 dark:text-slate-300">Verifica operaciones matemáticas y aisla los tests del estado actual.</p>
                {Array.isArray(testResults) && (
                  <ul className="mt-3 grid md:grid-cols-2 gap-2 text-sm">
                    {testResults.map((t, i) => (
                      <li key={i} className={`border rounded-xl px-3 py-2 ${t.pass ? "bg-emerald-50 dark:bg-emerald-900/20" : "bg-red-50 dark:bg-red-900/20"}`}>
                        <div className="font-medium">{t.name}</div>
                        <div>Resultado: {t.got.toFixed(2)}% | Esperado: {t.expected.toFixed(2)}%</div>
                        <div className="text-xs">{t.pass ? "OK" : "FALLÓ"}</div>
                      </li>
                    ))}
                  </ul>
                )}
                {Array.isArray(extResults) && (
                  <>
                    <h3 className="text-sm font-semibold mt-6">Resultados de validación extendida</h3>
                    <ul className="mt-3 grid md:grid-cols-2 gap-2 text-sm">
                      {extResults.map((t, i) => (
                        <li key={i} className={`border rounded-xl px-3 py-2 ${t.pass ? "bg-emerald-50 dark:bg-emerald-900/20" : "bg-red-50 dark:bg-red-900/20"}`}>
                          <div className="font-medium">{t.name}</div>
                          <div>Resultado: {typeof t.got === 'number' && t.got?.toFixed ? t.got.toFixed(2) : String(t.got)}</div>
                          <div className="text-xs">Esperado: {typeof t.expected === 'number' ? t.expected : String(t.expected)} — {t.pass ? "OK" : "FALLÓ"}</div>
                        </li>
                      ))}
                    </ul>
                    <div className="text-xs text-slate-600 dark:text-slate-300 mt-2">Pasaron {extResults.filter(t => t.pass).length}/{extResults.length}</div>
                  </>
                )}
              </section>

              <footer className="text-xs text-slate-500 dark:text-slate-400 pt-2 pb-24 md:pb-2">
                © {new Date().getFullYear()} – Uso educativo. No reemplaza guías clínicas ni juicio profesional.
              </footer>

              {/* Sticky toolbar (mobile) */}
              <div className="fixed md:hidden bottom-3 inset-x-0 px-3 no-print">
                <div className="mx-auto max-w-md rounded-2xl shadow-lg border bg-white dark:bg-slate-800 flex items-center justify-between p-2 gap-2">
                  <button onClick={printPDF} className="px-3 py-2 rounded-xl border flex-1">PDF</button>
                  <button onClick={() => setShowAbout(true)} className="px-3 py-2 rounded-xl border flex-1">Acerca</button>
                  <button title="Editar multiplicadores" onClick={() => setShowAdvanced((v) => !v)} className="px-3 py-2 rounded-xl border flex-1">{showAdvanced ? "Ocultar" : "Avanzado"}</button>
                </div>
              </div>

              {/* Bibliografía */}
              {showBib && (
                <div className="fixed inset-0 z-50">
                  <div className="absolute inset-0 bg-black/40" onClick={() => setShowBib(false)} />
                  <div className="absolute inset-0 flex items-start justify-center p-4 md:p-10 overflow-auto">
                    <div className="w-full max-w-3xl bg-white dark:bg-slate-900 dark:text-slate-100 rounded-2xl shadow-xl border p-4 md:p-6">
                      <div className="flex items-center justify-between gap-2">
                        <h3 className="text-lg font-semibold">Bibliografía utilizada</h3>
                        <button onClick={() => setShowBib(false)} className="px-3 py-1 rounded-xl border">Cerrar</button>
                      </div>
                      <div className="mt-3 flex items-center gap-2">
                        <input className="w-full border rounded-xl px-3 py-2 dark:bg-slate-800" placeholder="Filtrar por autor, título, etiqueta..." value={bibQuery} onChange={(e) => setBibQuery(e.target.value)} />
                      </div>
                      <ul className="mt-4 space-y-3">
                        {BIBLIO.filter(b => {
                          if (!bibQuery.trim()) return true;
                          const q = bibQuery.toLowerCase();
                          return (
                            (b.title || "").toLowerCase().includes(q) ||
                            (b.authors || "").toLowerCase().includes(q) ||
                            (b.journal || "").toLowerCase().includes(q) ||
                            (b.tags || []).join(" ").toLowerCase().includes(q)
                          );
                        }).map((b) => (
                          <li key={b.key} className="border rounded-2xl p-3 dark:border-slate-700">
                            <div className="text-sm leading-relaxed">
                              <div className="font-medium">{b.title}</div>
                              <div className="opacity-80">{b.authors} – <em>{b.journal}</em> ({b.year})</div>
                              <div className="mt-1 text-xs opacity-90">{b.citation}</div>
                            </div>
                            <div className="mt-2 flex flex-wrap gap-2 items-center">
                              {b.doi && (<a href={`https://doi.org/${b.doi}`} target="_blank" rel="noreferrer noopener" className="px-2 py-1 rounded-xl border">DOI</a>)}
                              <a href={`https://pubmed.ncbi.nlm.nih.gov/?term=${encodeURIComponent((b.title || "") + " " + (b.journal || "") + " " + (b.year || ""))}`} target="_blank" rel="noreferrer noopener" className="px-2 py-1 rounded-xl border">PubMed</a>
                              {b.url && (<a href={b.url} target="_blank" rel="noreferrer noopener" className="px-2 py-1 rounded-xl border">Fuente</a>)}
                              <button onClick={async () => { try { await navigator.clipboard.writeText(b.citation); } catch {} }} className="px-2 py-1 rounded-xl border">Copiar cita</button>
                              {Array.isArray(b.tags) && b.tags.map(t => (<span key={t} className="text-xs px-2 py-0.5 rounded-full border bg-slate-50 dark:bg-slate-800">{t}</span>))}
                            </div>
                          </li>
                        ))}
                      </ul>
                    </div>
                  </div>
                </div>
              )}

              {/* Acerca / Metodología */}
              {showAbout && (
                <div className="fixed inset-0 z-50">
                  <div className="absolute inset-0 bg-black/40" onClick={() => setShowAbout(false)} />
                  <div className="absolute inset-0 flex items-start justify-center p-4 md:p-10 overflow-auto">
                    <div className="w-full max-w-3xl bg-white dark:bg-slate-900 dark:text-slate-100 rounded-2xl shadow-xl border p-4 md:p-6 space-y-3">
                      <div className="flex items-center justify-between gap-2">
                        <h3 className="text-lg font-semibold">Acerca de esta calculadora</h3>
                        <button onClick={() => setShowAbout(false)} className="px-3 py-1 rounded-xl border">Cerrar</button>
                      </div>
                      <p className="text-sm leading-relaxed">
                        Esta herramienta integra un <strong>riesgo base</strong> (p.ej., SCORE2, PCE, PREVENT, HEARTS/OPS) con multiplicadores por <strong>ateromatosis subclínica</strong> (CAC y número de territorios con placa), <strong>factores psicosociales</strong> (depresión/ansiedad) y <strong>antecedentes oncológicos</strong>.
                      </p>
                      <ol className="list-decimal pl-5 text-sm leading-relaxed space-y-1">
                        <li><strong>Modelo multiplicativo:</strong> <code>R_aj = R_base × M(CAC) × M(Territorios) × M(Psico) × M(Onco) × M(Social) × M(Educación)</code>. Multiplicadores por defecto conservadores y editables.</li>
                        <li><strong>Territorios:</strong> 4 lechos (carótida, aorta abdominal, ilíacas, femorales). Los multiplicadores son una aproximación basada en gradientes de riesgo y la clasificación por territorios (PESA), y pueden ser ajustados por el usuario en "Avanzado".</li>
                        <li><strong>Contexto social:</strong> El código postal se usa como proxy de los determinantes sociales de la salud (acceso a servicios, calidad de vida). Este factor es experimental y busca contextualizar mejor el riesgo. Actualmente, solo se ajusta para códigos postales específicos de zonas con determinantes sociales más adversos (ej. C1142 - Villa 31 en Buenos Aires).</li>
                        <li><strong>Validación:</strong> La aplicación incluye tests internos para garantizar que la lógica de cálculo se mantenga consistente. El objetivo final es ser una herramienta de validación clínica que ayude a comparar la reclasificación de riesgo.</li>
                      </ol>
                      <p className="text-sm leading-relaxed">Objetivo: Facilitar una <strong>validación clínica</strong> comparando la reclasificación vs. los scores tradicionales, evaluando calibración y discriminación.</p>
                    </div>
                  </div>
                </div>
              )}
            </div>
          </div>
        );
      }

      ReactDOM.createRoot(document.getElementById("root")).render(<App />);
    </script>
  </body>
</html>